<!DOCTYPE html>
<html lang="ms">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalendar Haid</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap");
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* WARDA site theme (pink/purple) */
      body {
        font-family: "Poppins", sans-serif;
        color: #fff;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #ff80ab, #ba68c8, #9575cd);
        background-size: 300% 300%;
        animation: bgMove 12s ease infinite;
        padding: 0 20px 20px; /* keep horizontal padding but let navbar sit at top */
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
      }

      @keyframes bgMove {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .navbar {
        display: flex;
        justify-content: center;
        gap: 24px;
        padding: 16px;
        background: rgba(173, 20, 87, 0.95);
        font-weight: 600;
        backdrop-filter: blur(6px);
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        border-radius: 0;
      }

      .navbar a {
        color: #fff;
        text-decoration: none;
        font-size: 16px;
        transition: color 0.3s ease;
      }

      .navbar a:hover,
      .navbar a.active {
        text-decoration: underline;
        color: #ffeef3;
      }

      .container {
        background: rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        max-width: 900px;
        width: 100%;
        padding: 30px;
        backdrop-filter: blur(8px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        color: #fff;
        margin-top: 20px; /* ensure container is below navbar */
      }

      h1 {
        color: #fff0f5;
        text-align: center;
        margin-bottom: 18px;
        font-size: 28px;
        font-weight: 800;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      }

      /* SECTION STYLES */
      .section {
        display: none;
      }

      .section.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* FORM STYLES */
      .question {
        margin-bottom: 30px;
        display: none;
      }

      .question.active {
        display: block;
        animation: fadeIn 0.5s ease-in;
      }

      .question-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
      }

      .options {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .option {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .option:hover {
        background: #e9ecef;
        border-color: #ad1457;
        transform: translateX(5px);
      }

      .option input[type="radio"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #ad1457;
      }

      .option label {
        cursor: pointer;
        flex: 1;
        font-size: 16px;
        color: #333;
      }

      .input-group {
        margin-top: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #555;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #ad1457;
      }

      .input-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .alert {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        color: #856404;
        font-weight: 500;
      }

      .alert.info {
        background: #d1ecf1;
        border-color: #17a2b8;
        color: #0c5460;
      }

      .alert.warning {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }

      .btn {
        background: linear-gradient(135deg, #ff80ab, #ad1457);
        color: white;
        border: none;
        padding: 12px 22px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        margin-top: 14px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(173, 20, 87, 0.25);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .progress {
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a18cd1);
        border-radius: 10px;
        transition: width 0.5s ease;
      }

      .hidden {
        display: none;
      }

      /* CALENDAR STYLES */
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calendar-header h2 {
        color: #fff0f5;
        font-size: 24px;
      }

      .month-nav {
        display: flex;
        gap: 10px;
      }

      .month-nav button {
        background: rgba(173, 20, 87, 0.95);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s ease;
      }

      .month-nav button:hover {
        background: rgba(173, 20, 87, 0.8);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 20px;
      }

      .day-header {
        text-align: center;
        font-weight: 600;
        color: #ffebef;
        padding: 10px;
        font-size: 14px;
      }

      .day-cell {
        aspect-ratio: 1;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: white;
        padding: 5px;
      }

      .day-cell.haid {
        background: #ffe6e6;
        border-color: #ff6b6b;
      }

      .day-cell.waktu-suci {
        background: #e6f7ff;
        border-color: #40a9ff;
      }

      .day-cell:hover {
        border-color: #ad1457;
        transform: scale(1.05);
      }

      .day-cell.empty {
        cursor: default;
        background: #f8f9fa;
        border-color: transparent;
      }

      .day-cell.empty:hover {
        transform: none;
        border-color: transparent;
      }

      .day-number {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .day-indicators {
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
        justify-content: center;
        align-items: center;
        margin-top: auto;
      }

      .blood-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.2);
      }

      .blood-dot.hitam {
        background: #2c3e50;
      }

      .blood-dot.merah {
        background: #e74c3c;
      }

      .blood-dot.perang {
        background: #8b4513;
      }

      .blood-dot.kuning {
        background: #f1c40f;
      }

      .blood-dot.keruh {
        background: #95a5a6;
      }

      .blood-dot.tidak-pasti {
        background: #6c757d;
      }

      .medicine-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 12px;
      }

      /* MODAL STYLES */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-header h3 {
        color: #ad1457;
        font-size: 22px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        color: #ad1457;
      }

      .form-section {
        margin-bottom: 25px;
      }

      .form-section h4 {
        color: #333;
        font-size: 16px;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .checkbox-item {
        flex: 1;
        min-width: calc(50% - 5px);
      }

      .checkbox-item.full-width {
        min-width: 100%;
      }

      .checkbox-item input[type="checkbox"] {
        display: none;
      }

      .checkbox-label {
        display: block;
        padding: 12px 15px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .checkbox-item input[type="checkbox"]:checked + .checkbox-label {
        background: #ad1457;
        color: white;
        border-color: #ad1457;
      }

      .checkbox-label.all-times {
        background: #fff3cd;
        border-color: #ffc107;
        font-weight: 600;
      }

      .checkbox-item
        input[type="checkbox"]:checked
        + .checkbox-label.all-times {
        background: #ff9800;
        color: white;
        border-color: #ff9800;
      }

      .radio-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .radio-item input[type="radio"] {
        display: none;
      }

      .radio-label {
        display: block;
        padding: 12px 15px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .radio-item input[type="radio"]:checked + .radio-label {
        background: #ad1457;
        color: white;
        border-color: #ad1457;
      }

      .color-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .color-btn {
        flex: 1;
        min-width: calc(33.333% - 7px);
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
      }

      .color-btn.selected {
        border-color: #ad1457;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(173, 20, 87, 0.3);
      }

      .color-btn.hitam {
        background: #2c3e50;
        color: white;
      }

      .color-btn.merah {
        background: #e74c3c;
        color: white;
      }

      .color-btn.perang {
        background: #8b4513;
        color: white;
      }

      .color-btn.kuning {
        background: #f1c40f;
        color: #333;
      }

      .color-btn.keruh {
        background: #95a5a6;
        color: white;
      }

      .color-btn.tidak-pasti {
        background: #6c757d;
        color: white;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }

      .btn-secondary {
        background: #6c757d;
      }

      .btn-secondary:hover {
        box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
      }

      .legend {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .legend h4 {
        font-size: 14px;
        color: #ad1457;
        margin-bottom: 10px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
        font-size: 13px;
        color: #666;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.1);
      }
      .legend-color.tidak-pasti {
        background: #6c757d;
      }

      /* Medicine Info Display */
      .medicine-info {
        margin-top: 20px;
        padding: 15px;
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
      }

      .medicine-info h4 {
        color: #856404;
        font-size: 16px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .medicine-info p {
        color: #856404;
        font-size: 14px;
        margin: 5px 0;
      }

      .medicine-info strong {
        font-weight: 600;
      }

      /* Status Summary Panel */
      .status-summary {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px solid #e9ecef;
      }

      .status-summary h4 {
        color: #ad1457;
        font-size: 18px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-item {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #ad1457;
      }

      .status-item.haid {
        border-left-color: #ff6b6b;
      }

      .status-item.waktu-suci {
        border-left-color: #40a9ff;
      }

      .status-item.istihadah {
        border-left-color: #ffa940;
      }

      .status-item .date-range {
        font-weight: 600;
        color: #333;
        font-size: 15px;
      }

      .status-item .status-label {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-left: 10px;
      }

      .status-label.haid {
        background: #ffe6e6;
        color: #ff6b6b;
      }

      .status-label.waktu-suci {
        background: #e6f7ff;
        color: #40a9ff;
      }

      .status-label.istihadah {
        background: #fff7e6;
        color: #ffa940;
      }

      .status-item .description {
        font-size: 13px;
        color: #666;
        margin-top: 5px;
      }

      .day-status-label {
        position: absolute;
        top: 2px;
        left: 2px;
        font-size: 9px;
        font-weight: 600;
        padding: 2px 4px;
        border-radius: 3px;
      }

      .day-status-label.haid {
        background: #ff6b6b;
        color: white;
      }

      .day-status-label.suci {
        background: #40a9ff;
        color: white;
      }
      /* Highlight day cell when hours-only record exists: draw a colored ring */
      .day-cell.hours-mark {
        box-shadow: 0 0 0 3px var(--hours-color, rgba(0, 0, 0, 0.08));
      }

      /* User-requested: make calendar day numbers and specific form labels black */
      .calendar-header h2,
      .day-number,
      .day-cell .day-number,
      .status-item .date-range {
        color: #000 !important;
      }

      /* WAKTU SOLAT and Jenis Pendarahan parts: labels and headings in modal */
      .modal-content .form-section h4,
      .checkbox-label,
      .radio-label,
      .color-btn {
        color: #000 !important;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <a href="index.html">Laman Utama</a>
      <a href="option.html">Profil</a>
      <a href="calendar.html" class="active">Kalendar Haid</a>
      <a href="history.html">Sejarah</a>
      <a href="about.html">Tentang Kami</a>
      <a href="video.html">Info</a>
    </div>

    <div class="container">
      <h1>📅 Kalendar Haid</h1>

      <!-- SECTION 1: SOALAN -->
      <div class="section active" id="questionSection">
        <div class="progress">
          <div class="progress-bar" id="progressBar" style="width: 25%"></div>
        </div>

        <form id="haidForm">
          <!-- Soalan 1 -->
          <div class="question active" id="q1">
            <div class="question-title">1. Adakah turun darah?</div>
            <div class="options">
              <div class="option">
                <input type="radio" name="q1" id="q1_ya" value="ya" />
                <label for="q1_ya">Ya</label>
              </div>
              <div class="option">
                <input type="radio" name="q1" id="q1_tidak" value="tidak" />
                <label for="q1_tidak">Tidak</label>
              </div>
            </div>

            <div id="q1_tidak_detail" class="input-group hidden">
              <label>Nyatakan warna cecair yang keluar:</label>
              <input
                type="text"
                id="warna_cecair"
                placeholder="Contoh: kehijauan, kekuningan, dll"
              />
              <div class="alert warning">
                ⚠️ Sila rujuk kepada pakar perubatan sekiranya tidak pasti
              </div>
            </div>
          </div>

          <!-- Soalan 2 -->
          <div class="question" id="q2">
            <div class="question-title">
              2. Adakah pertama kali keluar darah?
            </div>
            <div class="options">
              <div class="option">
                <input type="radio" name="q2" id="q2_ya" value="ya" />
                <label for="q2_ya">Ya</label>
              </div>
              <div class="option">
                <input type="radio" name="q2" id="q2_tidak" value="tidak" />
                <label for="q2_tidak">Tidak</label>
              </div>
            </div>

            <div id="q2_ya_detail" class="input-group hidden">
              <label>Nyatakan umur keluar darah:</label>
              <input
                type="number"
                id="umur_darah"
                placeholder="Masukkan umur"
                min="1"
                max="100"
              />
              <div class="alert info" id="umur_alert" style="display: none">
                ℹ️ Sekiranya umur 9 tahun dan ke atas, sila rujuk pakar agama
              </div>
            </div>

            <div id="q2_tidak_detail" class="input-group hidden">
              <label>Berapa hari HAID sebelum ini (Adat):</label>
              <input
                type="number"
                id="adat_hari"
                placeholder="Masukkan bilangan hari"
                min="1"
                max="15"
              />
              <span
                style="
                  font-size: 14px;
                  color: #666;
                  display: block;
                  margin-top: 5px;
                "
                >Contoh: 5 hari, 7 hari, dll</span
              >
            </div>
          </div>

          <!-- Soalan 3 -->
          <div class="question" id="q3">
            <div class="question-title">3. Adakah boleh beza darah?</div>
            <div class="options">
              <div class="option">
                <input type="radio" name="q3" id="q3_ya" value="ya" />
                <label for="q3_ya">Ya</label>
              </div>
              <div class="option">
                <input
                  type="radio"
                  name="q3"
                  id="q3_tidak"
                  value="tidak_pasti"
                />
                <label for="q3_tidak">Tidak Pasti</label>
              </div>
            </div>
          </div>

          <!-- Soalan 4 -->
          <div class="question" id="q4">
            <div class="question-title">
              4. Adakah sedang mengambil apa-apa ubat?
            </div>
            <div class="options">
              <div class="option">
                <input type="radio" name="q4" id="q4_ya" value="ya" />
                <label for="q4_ya">Ya</label>
              </div>
              <div class="option">
                <input type="radio" name="q4" id="q4_tidak" value="tidak" />
                <label for="q4_tidak">Tidak</label>
              </div>
            </div>

            <div id="q4_ya_detail" class="input-group hidden">
              <label>Nyatakan jenis ubat:</label>
              <textarea
                id="jenis_ubat"
                placeholder="Contoh: Pil perancang, ubat hormon, dll"
              ></textarea>

              <label style="margin-top: 15px">Ubat untuk penyakit apa:</label>
              <input
                type="text"
                id="ubat_penyakit"
                placeholder="Contoh: Darah tinggi, diabetes, tiroid, dll"
              />
            </div>
          </div>

          <button type="button" class="btn" id="nextBtn" style="display: none">
            Seterusnya ke Kalendar
          </button>
        </form>
      </div>

      <!-- SECTION 2: KALENDAR -->
      <div class="section" id="calendarSection">
        <div class="calendar-header">
          <h2 id="currentMonth"></h2>
          <div class="month-nav">
            <button type="button" id="prevMonth">← Bulan Lepas</button>
            <button type="button" id="nextMonth">Bulan Depan →</button>
          </div>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>

        <div class="legend">
          <h4>Legenda Warna Darah:</h4>
          <div class="legend-item">
            <div class="legend-color hitam"></div>
            <span>Hitam</span>
          </div>
          <div class="legend-item">
            <div class="legend-color merah"></div>
            <span>Merah</span>
          </div>
          <div class="legend-item">
            <div class="legend-color perang"></div>
            <span>Perang</span>
          </div>
          <div class="legend-item">
            <div class="legend-color kuning"></div>
            <span>Kuning</span>
          </div>
          <div class="legend-item">
            <div class="legend-color keruh"></div>
            <span>Keruh</span>
          </div>
          <div class="legend-item">
            <div class="legend-color tidak-pasti"></div>
            <span>Tidak Pasti</span>
          </div>
          <div class="legend-item" style="margin-top: 10px">
            <span>🚨</span>
            <span>Mengambil ubat</span>
          </div>
          <div class="legend-item">
            <span style="font-size: 11px; font-style: italic"
              >*Bilangan bulat = bilangan waktu solat</span
            >
          </div>
        </div>

        <!-- Medicine Info Display -->
        <div class="medicine-info" id="medicineInfo" style="display: none">
          <h4>🚨 Maklumat Ubat</h4>
          <p>
            <strong>Jenis Ubat:</strong> <span id="displayJenisUbat"></span>
          </p>
          <p>
            <strong>Untuk Penyakit:</strong>
            <span id="displayUbatPenyakit"></span>
          </p>
        </div>

        <div
          style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap"
        >
          <button
            type="button"
            class="btn"
            id="checkStatusBtn"
            style="
              width: auto;
              flex: 1;
              min-width: 200px;
              background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            "
          >
            🔍 Semak Status Darah Saya
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            id="resetAllData"
            style="width: auto; flex: 1; min-width: 150px"
          >
            🗑️ Reset Semua Data
          </button>
          <button
            type="button"
            class="btn"
            id="saveAndFinish"
            style="width: auto; flex: 1; min-width: 150px"
          >
            💾 Simpan & Selesai
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL UNTUK REKOD HARIAN -->
    <div class="modal" id="dayModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalDate"></h3>
          <button type="button" class="close-btn" id="closeModal">
            &times;
          </button>
        </div>

        <form id="dayForm">
          <!-- Waktu Solat -->
          <div class="form-section">
            <h4>Waktu Solat (Bila darah turun)</h4>
            <div class="checkbox-group">
              <div class="checkbox-item full-width">
                <input type="checkbox" id="waktu_semua" value="Semua" />
                <label for="waktu_semua" class="checkbox-label all-times"
                  >✨ Semua Waktu</label
                >
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="waktu_subuh"
                  value="Subuh"
                  class="waktu-single"
                />
                <label for="waktu_subuh" class="checkbox-label">Subuh</label>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="waktu_zuhur"
                  value="Zuhur"
                  class="waktu-single"
                />
                <label for="waktu_zuhur" class="checkbox-label">Zuhur</label>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="waktu_asar"
                  value="Asar"
                  class="waktu-single"
                />
                <label for="waktu_asar" class="checkbox-label">Asar</label>
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="waktu_maghrib"
                  value="Maghrib"
                  class="waktu-single"
                />
                <label for="waktu_maghrib" class="checkbox-label"
                  >Maghrib</label
                >
              </div>
              <div class="checkbox-item">
                <input
                  type="checkbox"
                  id="waktu_isyak"
                  value="Isyak"
                  class="waktu-single"
                />
                <label for="waktu_isyak" class="checkbox-label">Isyak</label>
              </div>
            </div>
          </div>

          <!-- Berapa Jam -->
          <div class="form-section">
            <h4>Berapa jam darah turun hari ini?</h4>
            <div class="input-group">
              <label for="durasi_jam">Masukkan jumlah jam (0 - 24)</label>
              <input
                type="number"
                id="durasi_jam"
                min="0"
                max="24"
                step="0.5"
                placeholder="Contoh: 2.5"
              />
              <span
                style="
                  font-size: 13px;
                  color: #666;
                  display: block;
                  margin-top: 6px;
                "
                >Isi jika anda mahu kira mengikut jam; kosongkan untuk guna
                kiraan hari sedia ada.</span
              >
            </div>
          </div>

          <!-- Jenis Pendarahan -->
          <div class="form-section">
            <h4>Jenis Pendarahan</h4>
            <div class="radio-group">
              <div class="radio-item">
                <input
                  type="radio"
                  name="jenis_pendarahan"
                  id="pendarahan_banyak"
                  value="banyak"
                />
                <label for="pendarahan_banyak" class="radio-label"
                  >🔴 Pendarahan Banyak</label
                >
              </div>
              <div class="radio-item">
                <input
                  type="radio"
                  name="jenis_pendarahan"
                  id="pendarahan_ringan"
                  value="ringan"
                />
                <label for="pendarahan_ringan" class="radio-label"
                  >🟠 Pendarahan Ringan</label
                >
              </div>
              <div class="radio-item">
                <input
                  type="radio"
                  name="jenis_pendarahan"
                  id="pendarahan_tompok"
                  value="tompok"
                />
                <label for="pendarahan_tompok" class="radio-label"
                  >🟡 Tompok-tompok</label
                >
              </div>
            </div>
          </div>

          <!-- Warna Darah -->
          <div class="form-section">
            <h4>Warna Darah</h4>
            <div class="color-buttons" id="colorButtons">
              <button type="button" class="color-btn hitam" data-color="hitam">
                Hitam
              </button>
              <button type="button" class="color-btn merah" data-color="merah">
                Merah
              </button>
              <button
                type="button"
                class="color-btn perang"
                data-color="perang"
              >
                Perang
              </button>
              <button
                type="button"
                class="color-btn kuning"
                data-color="kuning"
              >
                Kuning
              </button>
              <button type="button" class="color-btn keruh" data-color="keruh">
                Keruh
              </button>
              <button
                type="button"
                class="color-btn tidak-pasti"
                data-color="tidak-pasti"
              >
                Tidak Pasti
              </button>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="deleteRecord">
              Padam Rekod
            </button>
            <button type="submit" class="btn">Simpan</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL UNTUK STATUS DARAH -->
    <div class="modal" id="statusModal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3>🔍 Status Darah Saya</h3>
          <button type="button" class="close-btn" id="closeStatusModal">
            &times;
          </button>
        </div>

        <div id="statusModalContent">
          <!-- Content will be generated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // Store user medicine info
      let userMedicineInfo = {
        takingMedicine: false,
        jenisUbat: "",
        ubatPenyakit: "",
      };

      // FORM SECTION LOGIC
      const form = document.getElementById("haidForm");
      const progressBar = document.getElementById("progressBar");
      const nextBtn = document.getElementById("nextBtn");
      const questionSection = document.getElementById("questionSection");
      const calendarSection = document.getElementById("calendarSection");
      let currentQuestion = 1;
      const totalQuestions = 4;

      // Soalan 1 handler
      document.querySelectorAll('input[name="q1"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          const q1TidakDetail = document.getElementById("q1_tidak_detail");

          if (this.value === "tidak") {
            q1TidakDetail.classList.remove("hidden");
            hideAllQuestionsAfter(1);
            nextBtn.style.display = "block";
          } else {
            q1TidakDetail.classList.add("hidden");
            showQuestion(2);
            nextBtn.style.display = "none";
          }
          updateProgress();
        });
      });

      // Soalan 2 handler
      document.querySelectorAll('input[name="q2"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          const q2YaDetail = document.getElementById("q2_ya_detail");
          const q2TidakDetail = document.getElementById("q2_tidak_detail");

          if (this.value === "ya") {
            q2YaDetail.classList.remove("hidden");
            q2TidakDetail.classList.add("hidden");
            hideAllQuestionsAfter(2);
            nextBtn.style.display = "block";
          } else {
            q2YaDetail.classList.add("hidden");
            q2TidakDetail.classList.remove("hidden");
            showQuestion(3);
            nextBtn.style.display = "none";
          }
          updateProgress();
        });
      });

      // Umur handler untuk alert
      document
        .getElementById("umur_darah")
        ?.addEventListener("input", function () {
          const umur = parseInt(this.value);
          const alert = document.getElementById("umur_alert");
          if (umur >= 9) {
            alert.style.display = "block";
          } else {
            alert.style.display = "none";
          }
        });

      // Soalan 3 handler
      document.querySelectorAll('input[name="q3"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          showQuestion(4);
          updateProgress();
        });
      });

      // Soalan 4 handler
      document.querySelectorAll('input[name="q4"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          const q4YaDetail = document.getElementById("q4_ya_detail");

          if (this.value === "ya") {
            q4YaDetail.classList.remove("hidden");
            userMedicineInfo.takingMedicine = true;
          } else {
            q4YaDetail.classList.add("hidden");
            userMedicineInfo.takingMedicine = false;
          }
          nextBtn.style.display = "block";
          updateProgress();
        });
      });

      function showQuestion(questionNum) {
        document.getElementById(`q${questionNum}`).classList.add("active");
        currentQuestion = questionNum;
      }

      function hideAllQuestionsAfter(questionNum) {
        for (let i = questionNum + 1; i <= totalQuestions; i++) {
          document.getElementById(`q${i}`).classList.remove("active");
        }
      }

      function updateProgress() {
        const answeredQuestions = document.querySelectorAll(
          'input[type="radio"]:checked'
        ).length;
        const progress = (answeredQuestions / totalQuestions) * 100;
        progressBar.style.width = progress + "%";
      }

      // Next button to calendar
      nextBtn.addEventListener("click", function () {
        // Save medicine info
        if (userMedicineInfo.takingMedicine) {
          userMedicineInfo.jenisUbat =
            document.getElementById("jenis_ubat").value;
          userMedicineInfo.ubatPenyakit =
            document.getElementById("ubat_penyakit").value;

          // Display medicine info
          document.getElementById("medicineInfo").style.display = "block";
          document.getElementById("displayJenisUbat").textContent =
            userMedicineInfo.jenisUbat;
          document.getElementById("displayUbatPenyakit").textContent =
            userMedicineInfo.ubatPenyakit;
        }

        questionSection.classList.remove("active");
        calendarSection.classList.add("active");
        initCalendar();
      });

      // CALENDAR SECTION LOGIC
      let currentDate = new Date();
      let calendarData = {};
      let selectedDate = null;
      let showStatusColors = false; // Flag to control status colors display

      const monthNames = [
        "Januari",
        "Februari",
        "Mac",
        "April",
        "Mei",
        "Jun",
        "Julai",
        "Ogos",
        "September",
        "Oktober",
        "November",
        "Disember",
      ];
      const dayNames = ["Ahd", "Isn", "Sel", "Rab", "Kha", "Jum", "Sab"];

      function initCalendar() {
        renderCalendar();

        document.getElementById("prevMonth").addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        });

        document.getElementById("nextMonth").addEventListener("click", () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        });
      }

      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById(
          "currentMonth"
        ).textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const grid = document.getElementById("calendarGrid");
        grid.innerHTML = "";

        // Add day headers
        dayNames.forEach((day) => {
          const header = document.createElement("div");
          header.className = "day-header";
          header.textContent = day;
          grid.appendChild(header);
        });

        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "day-cell empty";
          grid.appendChild(emptyCell);
        }

        // Add day cells
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCell = document.createElement("div");
          dayCell.className = "day-cell";

          const dateKey = `${year}-${month + 1}-${day}`;

          const dayNumber = document.createElement("div");
          dayNumber.className = "day-number";
          dayNumber.textContent = day;
          dayCell.appendChild(dayNumber);

          // Add medicine icon if user is taking medicine and day has record
          if (userMedicineInfo.takingMedicine && calendarData[dateKey]) {
            const medicineIcon = document.createElement("div");
            medicineIcon.className = "medicine-icon";
            medicineIcon.textContent = "🚨";
            dayCell.appendChild(medicineIcon);
          }

          // Add blood dots: prefer waktuSolat dots; if none but hours provided, show one dot
          if (calendarData[dateKey]) {
            const indicatorsDiv = document.createElement("div");
            indicatorsDiv.className = "day-indicators";

            const rec = calendarData[dateKey];
            const waktuCount = rec.waktuSolat?.length || 0;
            const warnaDarah = rec.warnaDarah || "";
            // map warna names to hex for ring/circle styling
            const colorMap = {
              hitam: "#2c3e50",
              merah: "#e74c3c",
              perang: "#8b4513",
              kuning: "#f1c40f",
              keruh: "#95a5a6",
              "tidak-pasti": "#6c757d",
            };

            if (waktuCount > 0) {
              // Create dots for each waktu solat
              for (let i = 0; i < waktuCount; i++) {
                const dot = document.createElement("div");
                dot.className = `blood-dot ${warnaDarah}`;
                indicatorsDiv.appendChild(dot);
              }
            } else if (typeof rec.hours === "number") {
              // If hours recorded but no waktu selected, show a single dot colored by darah
              const dot = document.createElement("div");
              dot.className = `blood-dot ${warnaDarah}`;
              // optional tooltip: hours
              dot.title = `${rec.hours} jam darah`;
              indicatorsDiv.appendChild(dot);
              // Add a colored ring around the day cell to highlight hours-only entries
              const hex = colorMap[warnaDarah] || "#95a5a6";
              dayCell.classList.add("hours-mark");
              dayCell.style.setProperty("--hours-color", hex);
            }

            dayCell.appendChild(indicatorsDiv);
          }

          dayCell.addEventListener("click", () =>
            openDayModal(year, month, day)
          );
          grid.appendChild(dayCell);
        }
      }

      function calculateDayStatuses(year, month, daysInMonth) {
        const statuses = {};

        // Find all bleeding periods in this month
        const bleedingDays = [];
        for (let day = 1; day <= daysInMonth; day++) {
          const dateKey = `${year}-${month + 1}-${day}`;
          if (calendarData[dateKey]) {
            bleedingDays.push(day);
          }
        }

        if (bleedingDays.length === 0) return statuses;

        // Group consecutive bleeding days into periods
        const periods = [];
        let currentPeriod = [bleedingDays[0]];

        for (let i = 1; i < bleedingDays.length; i++) {
          if (bleedingDays[i] === bleedingDays[i - 1] + 1) {
            currentPeriod.push(bleedingDays[i]);
          } else {
            periods.push([...currentPeriod]);
            currentPeriod = [bleedingDays[i]];
          }
        }
        periods.push(currentPeriod);

        // Analyze each period
        periods.forEach((period) => {
          const startDay = period[0];
          const endDay = period[period.length - 1];
          const duration = period.length;

          // HAID: minimum 1 day (24 hours), maximum 15 days
          if (duration >= 1 && duration <= 15) {
            // Mark as HAID
            period.forEach((day) => {
              statuses[day] = "haid";
            });

            // Mark WAKTU SUCI: minimum 15 days after HAID ends
            const waktuSuciStart = endDay + 1;
            const waktuSuciEnd = Math.min(endDay + 15, daysInMonth);

            for (let day = waktuSuciStart; day <= waktuSuciEnd; day++) {
              const dateKey = `${year}-${month + 1}-${day}`;
              // Only mark as waktu suci if no bleeding on that day
              if (!calendarData[dateKey]) {
                statuses[day] = "waktu-suci";
              }
            }
          }
        });

        return statuses;
      }

      // MODAL LOGIC
      const dayModal = document.getElementById("dayModal");
      const dayForm = document.getElementById("dayForm");
      const closeModal = document.getElementById("closeModal");
      const deleteRecord = document.getElementById("deleteRecord");

      // Handle "Semua Waktu" checkbox
      const semuaWaktuCheckbox = document.getElementById("waktu_semua");
      const singleWaktuCheckboxes = document.querySelectorAll(".waktu-single");

      semuaWaktuCheckbox.addEventListener("change", function () {
        if (this.checked) {
          singleWaktuCheckboxes.forEach((cb) => {
            cb.checked = true;
            cb.disabled = true;
          });
          // when all waktu selected, disable durasi input
          const dur = document.getElementById("durasi_jam");
          if (dur) {
            dur.value = "";
            dur.disabled = true;
          }
        } else {
          singleWaktuCheckboxes.forEach((cb) => {
            cb.disabled = false;
            // re-enable durasi input
            const dur = document.getElementById("durasi_jam");
            if (dur) dur.disabled = false;
          });
        }
      });

      // If user fills "Berapa jam" we disable waktu checkboxes (not required)
      const durasiInput = document.getElementById("durasi_jam");
      if (durasiInput) {
        durasiInput.addEventListener("input", function () {
          const hasHours = this.value !== "" && !isNaN(parseFloat(this.value));
          if (hasHours) {
            // disable waktu checkboxes and uncheck
            semuaWaktuCheckbox.checked = false;
            semuaWaktuCheckbox.disabled = true;
            singleWaktuCheckboxes.forEach((cb) => {
              cb.checked = false;
              cb.disabled = true;
            });
          } else {
            semuaWaktuCheckbox.disabled = false;
            singleWaktuCheckboxes.forEach((cb) => {
              cb.disabled = false;
            });
          }
        });
      }

      singleWaktuCheckboxes.forEach((cb) => {
        cb.addEventListener("change", function () {
          const anyChecked = Array.from(singleWaktuCheckboxes).some(
            (checkbox) => checkbox.checked
          );
          const allChecked = Array.from(singleWaktuCheckboxes).every(
            (checkbox) => checkbox.checked
          );
          if (allChecked) {
            semuaWaktuCheckbox.checked = true;
          } else {
            semuaWaktuCheckbox.checked = false;
          }

          // If any waktu is checked, disable durasi input and clear it
          const dur = document.getElementById("durasi_jam");
          if (dur) {
            if (anyChecked) {
              dur.value = "";
              dur.disabled = true;
            } else {
              dur.disabled = false;
            }
          }
        });
      });

      function openDayModal(year, month, day) {
        selectedDate = `${year}-${month + 1}-${day}`;
        const date = new Date(year, month, day);
        const dateStr = `${day} ${monthNames[month]} ${year}`;

        document.getElementById("modalDate").textContent = dateStr;

        // Load existing data if any
        if (calendarData[selectedDate]) {
          loadDayData(calendarData[selectedDate]);
        } else {
          resetDayForm();
        }

        dayModal.classList.add("active");
      }

      function loadDayData(data) {
        // Reset first
        resetDayForm();

        // Load waktu solat
        const allWaktu = ["Subuh", "Zuhur", "Asar", "Maghrib", "Isyak"];
        const allChecked = allWaktu.every((waktu) =>
          data.waktuSolat.includes(waktu)
        );

        if (allChecked) {
          semuaWaktuCheckbox.checked = true;
          singleWaktuCheckboxes.forEach((cb) => {
            cb.checked = true;
            cb.disabled = true;
          });
        } else {
          data.waktuSolat?.forEach((waktu) => {
            const checkbox = document.getElementById(
              `waktu_${waktu.toLowerCase()}`
            );
            if (checkbox) checkbox.checked = true;
          });
        }

        // Load jenis pendarahan
        if (data.jenisPendarahan) {
          const radio = document.getElementById(
            `pendarahan_${data.jenisPendarahan}`
          );
          if (radio) radio.checked = true;
        }

        // Load warna darah
        if (data.warnaDarah) {
          document.querySelectorAll(".color-btn").forEach((btn) => {
            btn.classList.remove("selected");
            if (btn.dataset.color === data.warnaDarah) {
              btn.classList.add("selected");
            }
          });
        }
        // Load durasi jam jika ada
        if (data.hours !== undefined && document.getElementById("durasi_jam")) {
          const dur = document.getElementById("durasi_jam");
          dur.value = data.hours;
          // If hours is present, make waktu solat optional and disable waktu inputs
          semuaWaktuCheckbox.checked = false;
          semuaWaktuCheckbox.disabled = true;
          singleWaktuCheckboxes.forEach((cb) => {
            cb.checked = false;
            cb.disabled = true;
          });
        }
      }

      function resetDayForm() {
        dayForm.reset();
        document.querySelectorAll(".color-btn").forEach((btn) => {
          btn.classList.remove("selected");
        });
        // reset waktu checkboxes and durasi input
        semuaWaktuCheckbox.checked = false;
        semuaWaktuCheckbox.disabled = false;
        singleWaktuCheckboxes.forEach((cb) => {
          cb.disabled = false;
          cb.checked = false;
        });
        const dur = document.getElementById("durasi_jam");
        if (dur) {
          dur.value = "";
          dur.disabled = false;
        }
      }

      closeModal.addEventListener("click", () => {
        dayModal.classList.remove("active");
      });

      // Close modal when clicking outside
      dayModal.addEventListener("click", (e) => {
        if (e.target === dayModal) {
          dayModal.classList.remove("active");
        }
      });

      // Color button selection
      document.querySelectorAll(".color-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          document
            .querySelectorAll(".color-btn")
            .forEach((b) => b.classList.remove("selected"));
          this.classList.add("selected");
        });
      });

      // Delete record
      deleteRecord.addEventListener("click", () => {
        if (confirm("Adakah anda pasti untuk memadam rekod ini?")) {
          delete calendarData[selectedDate];
          dayModal.classList.remove("active");
          renderCalendar();
        }
      });

      // Save day form
      dayForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const waktuSolat = [];

        // Check all waktu checkboxes except "Semua"
        const waktuCheckboxes = document.querySelectorAll(
          ".waktu-single:checked"
        );
        waktuCheckboxes.forEach((checkbox) => {
          waktuSolat.push(checkbox.value);
        });

        const jenisPendarahan = document.querySelector(
          'input[name="jenis_pendarahan"]:checked'
        )?.value;

        const selectedColor = document.querySelector(".color-btn.selected");
        const warnaDarah = selectedColor?.dataset.color;

        console.log("Checking data:", {
          waktuSolat,
          jenisPendarahan,
          warnaDarah,
          selectedDate,
        });

        if (!jenisPendarahan) {
          alert("Sila pilih jenis pendarahan!");
          return;
        }

        if (!warnaDarah) {
          alert("Sila pilih warna darah!");
          return;
        }

        // save hours if provided
        const hoursInput = document.getElementById("durasi_jam");
        const hoursVal =
          hoursInput && hoursInput.value !== ""
            ? parseFloat(hoursInput.value)
            : undefined;

        // Validation: require either waktuSolat or hours
        if (
          (hoursVal === undefined || isNaN(hoursVal)) &&
          waktuSolat.length === 0
        ) {
          alert(
            "Sila pilih sekurang-kurangnya satu waktu solat atau isi 'Berapa jam'!"
          );
          return;
        }

        calendarData[selectedDate] = {
          waktuSolat: waktuSolat,
          jenisPendarahan: jenisPendarahan,
          warnaDarah: warnaDarah,
          hours: hoursVal,
        };

        console.log("Data berjaya disimpan:", calendarData);
        alert("Rekod berjaya disimpan!");
        dayModal.classList.remove("active");
        renderCalendar();
      });

      // ===== Status calculation and modal display =====
      const statusModal = document.getElementById("statusModal");
      const statusModalContentEl =
        document.getElementById("statusModalContent");
      const checkStatusBtn = document.getElementById("checkStatusBtn");
      const closeStatusBtn = document.getElementById("closeStatusModal");

      checkStatusBtn.addEventListener("click", showStatusModal);
      closeStatusBtn.addEventListener("click", () =>
        statusModal.classList.remove("active")
      );
      statusModal.addEventListener("click", (e) => {
        if (e.target === statusModal) statusModal.classList.remove("active");
      });

      // Reset all data button: clear calendarData and UI
      const resetAllBtn = document.getElementById("resetAllData");
      if (resetAllBtn) {
        resetAllBtn.addEventListener("click", () => {
          if (!confirm("Adakah anda pasti untuk reset semua data kalendar?"))
            return;
          // Clear in-memory data
          calendarData = {};
          // Reset medicine info
          userMedicineInfo = {
            takingMedicine: false,
            jenisUbat: "",
            ubatPenyakit: "",
          };
          document.getElementById("medicineInfo").style.display = "none";
          // Close any open modals
          statusModal.classList.remove("active");
          dayModal.classList.remove("active");
          // Re-render calendar
          renderCalendar();
          alert("Semua data kalendar telah direset.");
        });
      }

      const DAY_MS = 24 * 60 * 60 * 1000;

      function formatDate(d) {
        return `${d.getDate()} ${monthNames[d.getMonth()]} ${d.getFullYear()}`;
      }

      // Compute HAID / WAKTU SUCI / ISTIHADAH from calendarData
      function computeStatusesFromCalendarData() {
        const keys = Object.keys(calendarData || {});
        if (keys.length === 0)
          return { haid: [], waktuSuci: [], istihadah: [] };

        // parse dates and sort
        const dates = keys
          .map((k) => {
            const parts = k.split("-").map(Number);
            return new Date(parts[0], parts[1] - 1, parts[2]);
          })
          .sort((a, b) => a - b);

        // Build periods. We keep two modes:
        // - If a date has explicit hours, we cluster all dates within a 15-day window
        //   from the cluster start (to allow non-consecutive bleeding days to form a HAID
        //   if total hours across <=15-day span >= 24).
        // - If a date has no hours, we group only consecutive days (original behavior).
        const periods = [];
        let i = 0;
        while (i < dates.length) {
          const start = new Date(dates[i]);
          let end = new Date(dates[i]);
          const startKey = dateKeyFromDate(start);
          const startRec = calendarData[startKey];
          const startHasHours = startRec && typeof startRec.hours === "number";

          if (startHasHours) {
            // cluster mode: include subsequent dates while within 15-day window from start
            let j = i + 1;
            while (j < dates.length) {
              const cand = dates[j];
              const diffDays = Math.round((cand - start) / DAY_MS);
              if (diffDays <= 14) {
                end = new Date(cand);
                j++;
              } else break;
            }
            periods.push({ start: new Date(start), end: new Date(end) });
            i = j;
          } else {
            // consecutive mode: include only directly consecutive days
            let j = i + 1;
            while (j < dates.length && dates[j] - dates[j - 1] === DAY_MS) {
              j++;
            }
            end = new Date(dates[j - 1]);
            periods.push({ start: new Date(start), end: new Date(end) });
            i = j;
          }
        }

        // Save calendarData into localStorage in history-friendly format and go to history page
        function saveCalendarToHistory() {
          if (!calendarData || Object.keys(calendarData).length === 0) {
            alert("Tiada data untuk disimpan ke Sejarah.");
            return;
          }

          // Iterate calendarData and write to localStorage using D-M-YYYY keys
          Object.keys(calendarData).forEach((key) => {
            const rec = calendarData[key];
            // key is YYYY-M-D (no zero padding)
            const parts = key.split("-").map(Number);
            const y = parts[0];
            const m = parts[1];
            const d = parts[2];
            const histKey = `${d}-${m}-${y}`; // history.html expects D-M-YYYY

            const store = {
              prayers: rec.waktuSolat || [],
              bleeding: rec.jenisPendarahan || "",
              color: rec.warnaDarah || "",
              hours: typeof rec.hours === "number" ? rec.hours : undefined,
            };

            try {
              localStorage.setItem(histKey, JSON.stringify(store));
            } catch (e) {
              console.error("Gagal menyimpan ke localStorage", e);
            }
          });

          alert("Data telah disimpan ke Sejarah.");
          // Redirect to history page so user can view saved records
          window.location.href = "history.html";
        }

        const saveAndFinishBtn = document.getElementById("saveAndFinish");
        if (saveAndFinishBtn) {
          saveAndFinishBtn.addEventListener("click", saveCalendarToHistory);
        }

        const haid = [];
        const istihadah = [];

        // Helper to format date key used in calendarData
        function dateKeyFromDate(d) {
          return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
        }

        // classify periods using hours if provided; otherwise fallback to duration
        periods.forEach((p) => {
          // collect each recorded date within the period (only recorded dates)
          const recordedDates = [];
          for (
            let dt = new Date(p.start);
            dt <= p.end;
            dt.setDate(dt.getDate() + 1)
          ) {
            const key = dateKeyFromDate(dt);
            if (calendarData[key]) recordedDates.push(new Date(dt));
          }

          // sum hours if any recorded day has an explicit hours value
          let hasAnyHours = false;
          let sumHours = 0;
          recordedDates.forEach((d) => {
            const key = dateKeyFromDate(d);
            const rec = calendarData[key];
            if (rec && typeof rec.hours === "number") {
              hasAnyHours = true;
              sumHours += rec.hours;
            }
          });

          if (hasAnyHours) {
            // If total reported hours across the cluster >= 24 => HAID, else ISTIHADAH
            if (sumHours >= 24) {
              haid.push(p);
            } else {
              istihadah.push(p);
            }
            return; // next period
          }

          // Fallback: classify by duration (original consecutive-days behavior)
          const duration = Math.round((p.end - p.start) / DAY_MS) + 1;
          if (duration >= 1 && duration <= 15) {
            haid.push(p);
          } else {
            istihadah.push(p);
          }
        });

        // compute WAKTU SUCI per HAID period
        const waktuSuci = [];
        haid.forEach((h, idx) => {
          const suciStart = new Date(h.end);
          suciStart.setDate(suciStart.getDate() + 1);

          // find next HAID start if exists
          const nextH = haid[idx + 1];
          let suciEnd;
          if (nextH) {
            // WAKTU SUCI will end when next HAID begins (day before next HAID)
            suciEnd = new Date(nextH.start);
            suciEnd.setDate(suciEnd.getDate() - 1);
          } else {
            // if no next HAID, show minimum 15 days after HAID ends
            suciEnd = new Date(h.end);
            suciEnd.setDate(suciEnd.getDate() + 15);
          }

          // Only include if suciEnd >= suciStart
          if (suciEnd >= suciStart) {
            waktuSuci.push({ start: suciStart, end: suciEnd });
          }
        });

        return { haid, waktuSuci, istihadah };
      }

      // ---------- New: ISTIHADAH pseudocode implementation ----------
      // Helper: convert dateKey 'YYYY-M-D' to Date
      function dateKeyToDate(key) {
        const parts = key.split("-").map(Number);
        return new Date(parts[0], parts[1] - 1, parts[2]);
      }

      function dateToKey(d) {
        return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
      }

      // 2. kumpulkanHariBerdarah(kalendarData)
      function kumpulkanHariBerdarah(kalendarData) {
        const keys = Object.keys(kalendarData || {});
        if (keys.length === 0) return [];
        // sort keys by date
        keys.sort((a, b) => dateKeyToDate(a) - dateKeyToDate(b));

        const groups = [];
        let temp = [];
        for (let i = 0; i < keys.length; i++) {
          const key = keys[i];
          const curDate = dateKeyToDate(key);
          if (temp.length === 0) {
            temp.push(key);
          } else {
            const prevDate = dateKeyToDate(temp[temp.length - 1]);
            const diffDays = Math.round((curDate - prevDate) / DAY_MS);
            // group consecutive days only (break when gap > 1 day)
            if (diffDays === 1) {
              temp.push(key);
            } else {
              groups.push(temp);
              temp = [key];
            }
          }
        }
        if (temp.length) groups.push(temp);
        return groups; // array of arrays of dateKeys
      }

      // 5. adaWarnaHitamDalamHari(range) - check within first N days of group
      function adaWarnaHitamDalamHari(kumpulan, uptoIndex) {
        const end = Math.min(uptoIndex, kumpulan.length - 1);
        for (let i = 0; i <= end; i++) {
          const key = kumpulan[i];
          const rec = calendarData[key];
          if (rec && rec.warnaDarah === "hitam") return true;
        }
        return false;
      }

      // 4. tentukanBerdasarkanAdat(kumpulan, hariAdat)
      function tentukanBerdasarkanAdat(kumpulan, hariAdat) {
        const hasil = [];
        const total = kumpulan.length;
        const startDate = dateKeyToDate(kumpulan[0]);
        const haidEnd = new Date(startDate);
        haidEnd.setDate(startDate.getDate() + Math.max(0, hariAdat - 1));
        const istiadahStart = new Date(haidEnd);
        istiadahStart.setDate(istiadahStart.getDate() + 1);
        const groupEnd = dateKeyToDate(kumpulan[total - 1]);

        hasil.push({ jenis: "HAID", start: startDate, end: haidEnd });
        hasil.push({ jenis: "ISTIHADAH", start: istiadahStart, end: groupEnd });
        return hasil;
      }

      // 3. tentukanBerdasarkanWarna(kumpulan, hariAdat)
      function tentukanBerdasarkanWarna(kumpulan, hariAdat) {
        const hasil = [];
        const total = kumpulan.length;
        const startDate = dateKeyToDate(kumpulan[0]);
        const groupEndDate = dateKeyToDate(kumpulan[total - 1]);

        // build color array
        const colors = kumpulan.map(
          (k) => (calendarData[k] || {}).warnaDarah || null
        );

        // NEW: specific scenarios requested by user (apply when total > 15)
        if (total > 15) {
          const weakSet = new Set(["merah", "perang", "kuning", "keruh"]);

          // Case 1: first 1-5 weak, 6-10 all hitam -> 1-5 ISTIHADAH, 6-10 HAID, 11-last ISTIHADAH
          if (
            colors.slice(0, 5).every((c) => weakSet.has(c)) &&
            colors.slice(5, 10).length >= 5 &&
            colors.slice(5, 10).every((c) => c === "hitam")
          ) {
            const aStart = dateKeyToDate(kumpulan[0]);
            const aEnd = dateKeyToDate(kumpulan[4]);
            const bStart = dateKeyToDate(kumpulan[5]);
            const bEnd = dateKeyToDate(kumpulan[9]);
            const cStart = new Date(
              kumpulan.length > 10 ? dateKeyToDate(kumpulan[10]) : bEnd
            );
            const cEnd = groupEndDate;
            hasil.push({ jenis: "ISTIHADAH", start: aStart, end: aEnd });
            hasil.push({ jenis: "HAID", start: bStart, end: bEnd });
            if (cStart <= cEnd)
              hasil.push({ jenis: "ISTIHADAH", start: cStart, end: cEnd });
            return hasil;
          }

          // Case 2: first 1-5 hitam, 6-10 weak -> 1-10 HAID, 11-last ISTIHADAH
          if (
            colors.slice(0, 5).every((c) => c === "hitam") &&
            colors.slice(5, 10).every((c) => weakSet.has(c))
          ) {
            const haidStart = dateKeyToDate(kumpulan[0]);
            const haidEnd = dateKeyToDate(kumpulan[9]);
            const istStart = new Date(haidEnd);
            istStart.setDate(istStart.getDate() + 1);
            hasil.push({ jenis: "HAID", start: haidStart, end: haidEnd });
            if (istStart <= groupEndDate)
              hasil.push({
                jenis: "ISTIHADAH",
                start: istStart,
                end: groupEndDate,
              });
            return hasil;
          }

          // Case 3: total == 21 and first 1-7 hitam and 8-14 weak -> 1-14 HAID, 15-21 ISTIHADAH
          if (
            total === 21 &&
            colors.slice(0, 7).every((c) => c === "hitam") &&
            colors.slice(7, 14).every((c) => weakSet.has(c))
          ) {
            const haidStart = dateKeyToDate(kumpulan[0]);
            const haidEnd = dateKeyToDate(kumpulan[13]);
            const istStart = dateKeyToDate(kumpulan[14]);
            const istEnd = dateKeyToDate(kumpulan[20]);
            hasil.push({ jenis: "HAID", start: haidStart, end: haidEnd });
            hasil.push({ jenis: "ISTIHADAH", start: istStart, end: istEnd });
            return hasil;
          }
        }

        // condition 1: ada warna hitam dalam 1-15 (first up to 15 days)
        if (adaWarnaHitamDalamHari(kumpulan, 14)) {
          // find last index of hitam in group
          let lastHitam = -1;
          for (let i = 0; i < colors.length; i++)
            if (colors[i] === "hitam") lastHitam = i;
          if (lastHitam >= 0) {
            const haidStart = dateKeyToDate(kumpulan[0]);
            const haidEnd = dateKeyToDate(kumpulan[lastHitam]);
            const istStart = new Date(haidEnd);
            istStart.setDate(istStart.getDate() + 1);
            hasil.push({ jenis: "HAID", start: haidStart, end: haidEnd });
            hasil.push({
              jenis: "ISTIHADAH",
              start: istStart,
              end: groupEndDate,
            });
            return hasil;
          }
        }

        // condition 2: warna awal merah dan kemudian hitam exists
        if (colors[0] === "merah") {
          const hitamIdx = colors.findIndex((c) => c === "hitam");
          if (hitamIdx > 0) {
            const beforeHitamEnd = dateKeyToDate(kumpulan[hitamIdx - 1]);
            // find contiguous hitam block
            let hitamEndIdx = hitamIdx;
            while (
              hitamEndIdx + 1 < colors.length &&
              colors[hitamEndIdx + 1] === "hitam"
            )
              hitamEndIdx++;
            const hitamStart = dateKeyToDate(kumpulan[hitamIdx]);
            const hitamEnd = dateKeyToDate(kumpulan[hitamEndIdx]);
            const afterHitamStart = new Date(hitamEnd);
            afterHitamStart.setDate(afterHitamStart.getDate() + 1);

            hasil.push({
              jenis: "ISTIHADAH",
              start: dateKeyToDate(kumpulan[0]),
              end: beforeHitamEnd,
            });
            hasil.push({ jenis: "HAID", start: hitamStart, end: hitamEnd });
            if (afterHitamStart <= groupEndDate) {
              hasil.push({
                jenis: "ISTIHADAH",
                start: afterHitamStart,
                end: groupEndDate,
              });
            }
            return hasil;
          }
        }

        // condition 3: ada hitam dan merah berselang AND total > 15
        const hasHitam = colors.includes("hitam");
        const hasMerah = colors.includes("merah");
        if (hasHitam && hasMerah && total > 15) {
          const hariKe15 = dateKeyToDate(kumpulan[14]);
          const haidEnd = hariKe15;
          const istStart = new Date(haidEnd);
          istStart.setDate(istStart.getDate() + 1);
          hasil.push({ jenis: "HAID", start: startDate, end: haidEnd });
          hasil.push({
            jenis: "ISTIHADAH",
            start: istStart,
            end: groupEndDate,
          });
          return hasil;
        }

        // condition 4: darah lemah selepas kuat (hitam then merah)
        if (
          total >= 4 &&
          colors[0] === "hitam" &&
          colors[1] === "hitam" &&
          colors[2] === "hitam" &&
          colors.slice(3).every((c) => c === "merah")
        ) {
          const haidEnd = dateKeyToDate(kumpulan[2]);
          const istStart = new Date(haidEnd);
          istStart.setDate(istStart.getDate() + 1);
          hasil.push({ jenis: "HAID", start: startDate, end: haidEnd });
          hasil.push({
            jenis: "ISTIHADAH",
            start: istStart,
            end: groupEndDate,
          });
          return hasil;
        }

        // condition 5: two strong colors pattern (hitam & perang)
        if (
          total >= 10 &&
          colors.slice(0, 5).every((c) => c === "hitam") &&
          colors.slice(5, 10).every((c) => c === "perang")
        ) {
          const haidEnd = dateKeyToDate(kumpulan[9]);
          const istStart = new Date(haidEnd);
          istStart.setDate(istStart.getDate() + 1);
          hasil.push({ jenis: "HAID", start: startDate, end: haidEnd });
          hasil.push({
            jenis: "ISTIHADAH",
            start: istStart,
            end: groupEndDate,
          });
          return hasil;
        }

        // condition 6: warna bergilir dalam 15 hari -> gunakan hariAdat
        // heuristic: frequent switches in first 15 days
        const first15 = colors.slice(0, Math.min(15, colors.length));
        let switches = 0;
        for (let i = 1; i < first15.length; i++)
          if (first15[i] !== first15[i - 1]) switches++;
        if (switches >= 2) {
          // use hariAdat to split
          const haidEnd = new Date(startDate);
          haidEnd.setDate(haidEnd.getDate() + Math.max(0, hariAdat - 1));
          const istStart = new Date(haidEnd);
          istStart.setDate(istStart.getDate() + 1);
          hasil.push({ jenis: "HAID", start: startDate, end: haidEnd });
          hasil.push({
            jenis: "ISTIHADAH",
            start: istStart,
            end: groupEndDate,
          });
          return hasil;
        }

        // Default fallback: mark whole group as ISTIHADAH (conservative)
        hasil.push({ jenis: "ISTIHADAH", start: startDate, end: groupEndDate });
        return hasil;
      }

      // 1. tentukanStatusDarah(kalendarData, hariAdat, bolehBezaWarna)
      function tentukanStatusDarah(kalendarData, hariAdat, bolehBezaWarna) {
        const statusList = [];
        const kumpulan = kumpulkanHariBerdarah(kalendarData);
        kumpulan.forEach((kumpulan) => {
          const totalHari = kumpulan.length;
          if (totalHari <= 15) {
            // Semua dalam tempoh HAID
            statusList.push({
              jenis: "HAID",
              start: dateKeyToDate(kumpulan[0]),
              end: dateKeyToDate(kumpulan[kumpulan.length - 1]),
            });
          } else {
            let result = [];
            if (bolehBezaWarna === "YA") {
              result = tentukanBerdasarkanWarna(kumpulan, hariAdat);
            } else if (bolehBezaWarna === "TIDAK PASTI") {
              result = tentukanBerdasarkanAdat(kumpulan, hariAdat);
            }
            result.forEach((r) => statusList.push(r));
          }
        });
        return statusList;
      }

      // 6. paparanStatus(statusList) returns HTML for extra analysis
      function paparanStatus(statusList) {
        if (!statusList || statusList.length === 0)
          return '<div class="status-item"><div class="date-range">Tiada analisis tambahan</div></div>';
        let out = "";
        statusList.forEach((s) => {
          const label = s.jenis === "HAID" ? "HAID" : "ISTIHADAH (wajib solat)";
          out += `<div class=\"status-item ${
            s.jenis === "HAID" ? "haid" : "istihadah"
          }\"><div class=\"date-range\">${formatDate(s.start)} — ${formatDate(
            s.end
          )}</div><div class=\"description\">${label}</div></div>`;
        });
        return out;
      }

      // ---------- End of ISTIHADAH pseudocode implementation ----------

      function showStatusModal() {
        const { haid, waktuSuci, istihadah } =
          computeStatusesFromCalendarData();
        // Determine if any consecutive-group of recorded bleeding days
        // is longer than 15 days. If so, per user request we show only
        // the colour/adat-based analysis (renamed to "Analisa DARAH")
        // and do NOT display the HAID / WAKTU SUCI / ISTIHADAH summaries.
        const groups = kumpulkanHariBerdarah(calendarData);
        const hasLongGroup = groups.some((g) => g.length > 15);
        // detect any hours-recorded entries (if any cluster used hours)
        const anyHoursPresent = Object.values(calendarData || {}).some(
          (rec) => rec && typeof rec.hours === "number"
        );
        // detect consecutive HAID pairs where the gap from the last day of
        // the first HAID (cur.end) to the first day of the next HAID
        // (next.start) is less than 15 days AND where a WAKTU SUCI range is
        // displayed for the first HAID. This matches the requested rule:
        // "tempoh hari daripada hari terakhir keluar darah yang pertama
        // sehingga hari pertama keluar darah seterusnya kurang daripada 15 hari".
        // NOTE: gapDays = (next.start - cur.end) in days. Assumption: we use
        // exclusive gap counting (not including cur.end).
        const shortHaidSpans = [];
        for (let i = 0; i < haid.length - 1; i++) {
          const cur = haid[i];
          const next = haid[i + 1];
          const gapDays = Math.round((next.start - cur.end) / DAY_MS);
          if (!(Array.isArray(waktuSuci) && !!waktuSuci[i])) continue;
          const suci = waktuSuci[i];
          // Check whether any bleeding record exists inside this WAKTU SUCI range
          let hasBleedingInSuci = false;
          for (
            let d = new Date(suci.start);
            d <= suci.end;
            d.setDate(d.getDate() + 1)
          ) {
            const key = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
            if (calendarData[key]) {
              hasBleedingInSuci = true;
              break;
            }
          }
          // Show ulama opinions only if the suci range contains NO bleeding days
          if (gapDays < 15 && !hasBleedingInSuci) {
            const suciDays = Math.round((suci.end - suci.start) / DAY_MS) + 1;
            shortHaidSpans.push({
              idx: i,
              suciStart: suci.start,
              suciEnd: suci.end,
              suciDays: suciDays,
              gapDays: gapDays,
            });
          }
        }
        // If any group is longer than 15 days, show only the colour/adat-based
        // analysis (renamed "Analisa DARAH") and skip the standard sections.
        let html = "";
        try {
          const hariAdat =
            parseInt(document.getElementById("adat_hari")?.value) || 0;
          const q3Val = document.querySelector(
            'input[name="q3"]:checked'
          )?.value;
          const bolehBezaWarna = q3Val === "ya" ? "YA" : "TIDAK PASTI";
          const tambahan = tentukanStatusDarah(
            calendarData,
            hariAdat,
            bolehBezaWarna
          );

          // Only show the analysis if there is a long consecutive group (>15)
          // AND there are NO hours-recorded entries. Per request: if any
          // cluster is recorded by hours (<24 or >=24), do NOT show the analysis.
          if (hasLongGroup && !anyHoursPresent) {
            html += '<div class="status-summary">';
            html += "<h4>Analisa DARAH</h4>";
            html += paparanStatus(tambahan);
            html += "</div>";
            statusModalContentEl.innerHTML = html;
            statusModal.classList.add("active");
            return;
          }

          // Otherwise (no long groups) fall back to the original display:
          // HAID, WAKTU SUCI (including WAKTU KERING), ISTIHADAH, and the
          // additional analysis appended at the end (now titled Analisa DARAH).
        } catch (err) {
          console.error("Analisa ISTIHADAH error:", err);
        }

        // --- Original display path (15 days or less groups) ---
        // HAID
        html += '<div class="status-summary">';
        html += "<h4>HAID</h4>";
        if (haid.length === 0) {
          html +=
            '<div class="status-item"><div class="date-range">Tiada rekod HAID</div></div>';
        } else {
          haid.forEach((p) => {
            const days = Math.round((p.end - p.start) / DAY_MS) + 1;
            html += `<div class="status-item haid"><div class="date-range">${formatDate(
              p.start
            )} — ${formatDate(
              p.end
            )}</div><div class="description">Tempoh HAID: ${days} hari</div></div>`;
          });
        }
        html += "</div>";

        // Split WAKTU SUCI into normal and WAKTU KERING (those with ulama pendapat)
        const shortIndices = new Set(shortHaidSpans.map((s) => s.idx));
        const waktuSuciNormal = [];
        const waktuKering = [];
        waktuSuci.forEach((p, idx) => {
          const days = Math.round((p.end - p.start) / DAY_MS) + 1;
          if (shortIndices.has(idx)) {
            // keep index so we can match to the shortHaidSpans entry
            waktuKering.push({ idx, start: p.start, end: p.end, days });
          } else {
            waktuSuciNormal.push({ start: p.start, end: p.end, days });
          }
        });

        // WAKTU SUCI (normal)
        html += '<div class="status-summary">';
        html += "<h4>WAKTU SUCI</h4>";
        if (waktuSuciNormal.length === 0) {
          html +=
            '<div class="status-item waktu-suci"><div class="date-range">Tiada rekod WAKTU SUCI</div></div>';
        } else {
          waktuSuciNormal.forEach((p) => {
            html += `<div class="status-item waktu-suci"><div class="date-range">${formatDate(
              p.start
            )} — ${formatDate(p.end)}</div><div class="description">Tempoh: ${
              p.days
            } hari</div></div>`;
          });
        }
        html += "</div>";

        // WAKTU KERING (moved from WAKTU SUCI because ulama pendapat applies)
        if (waktuKering.length > 0) {
          html += '<div class="status-summary">';
          html += "<h4>WAKTU KERING</h4>";
          waktuKering.forEach((p) => {
            html += `<div class="status-item waktu-suci"><div class="date-range">${formatDate(
              p.start
            )} — ${formatDate(p.end)}</div><div class="description">Tempoh: ${
              p.days
            } hari</div>`;
            // find corresponding shortHaidSpans entry and include ulama opinions inline
            const s = shortHaidSpans.find((x) => x.idx === p.idx);
            if (s) {
              html += `<div class="description" style="margin-top:8px;"><strong>Pendapat ulama 1:</strong> HAID – solat dan puasa TIDAK SAH. Puasa sahaja wajib Qada'.</div>`;
              html += `<div class="description"><strong>Pendapat ulama 2:</strong> SUCI – solat dan puasa SAH di paparan WAKTU SUCI.</div>`;
              html += `<div class="description" style="font-style:italic; color:#555; margin-top:6px;">Rujuk WAKTU KERING: ${formatDate(
                s.suciStart
              )} — ${formatDate(s.suciEnd)} (${s.suciDays} hari)</div>`;
            }
            html += `</div>`;
          });
          html += "</div>";
        }

        // ISTIHADAH
        html += '<div class="status-summary">';
        html += "<h4>ISTIHADAH</h4>";
        if (istihadah.length === 0) {
          html +=
            '<div class="status-item istihadah"><div class="date-range">Tiada rekod ISTIHADAH</div></div>';
        } else {
          istihadah.forEach((p) => {
            const days = Math.round((p.end - p.start) / DAY_MS) + 1;
            html += `<div class="status-item istihadah"><div class="date-range">${formatDate(
              p.start
            )} — ${formatDate(
              p.end
            )}</div><div class="description">Tempoh: ${days} hari (lebih daripada 15 hari — dianggap ISTIHADAH)</div></div>`;
          });
        }
        html += "</div>";

        // Note: Analisa DARAH is intentionally NOT appended in the normal
        // display path. It is shown only when there exists a consecutive
        // bleeding group >15 days AND there are no hours-recorded entries.

        statusModalContentEl.innerHTML = html;
        statusModal.classList.add("active");
      }
    </script>
  </body>
</html>
